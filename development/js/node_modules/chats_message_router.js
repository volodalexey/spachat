var id_Generator = require('./id_generator');

var Chats_message_router = function(wscc) {
    this.wscc = wscc;
};

Chats_message_router.prototype = {

    get_chat_wscs: function(chat_id) {
        var chat_wscs = [];
        this.wscc.get_all_wsc().forEach(function(wsc) {
            if (wsc.readyState !== wsc.CLOSED && wsc.has_chat_id(chat_id)) {
                chat_wscs.push(wsc);
            }
        });
        return chat_wscs;
    },

    broadcast_chat_message: function(chat_id, responseData) {
        var active_wscs = [];
        this.get_chat_wscs(chat_id).forEach(function(wsc) {
            if (wsc.readyState !== wsc.CLOSED) {
                responseData.target_ws_device_id = wsc.ws_device_id;
                wsc.send(JSON.stringify(responseData));
                active_wscs.push(wsc);
            }
        });
        return active_wscs;
    },

    get_chat_wscs_device_ids: function(chat_id) {
        return this.get_chat_wscs(chat_id).filter(function(wsc) {
            return wsc.readyState !== wsc.CLOSED;
        }).map(function(wsc) {
            return wsc.get_ws_device_id();
        });
    },

    onDeviceCreateChat: function(cur_wsc, parsedMessageData) {
        var chat_id = id_Generator.generateId();
        cur_wsc.put_chat_id(chat_id);
        cur_wsc.put_user_id(parsedMessageData.user_id);

        var responseData = {
            type: 'chat_created',
            from_user_id: parsedMessageData.user_id,
            from_ws_device_id: cur_wsc.ws_device_id,
            chat_description: {
                chat_id: chat_id
            }
        };

        cur_wsc.send(JSON.stringify(responseData));

        console.log('Create chat from',
            'ws_device_id = ' + cur_wsc.ws_device_id,
            'user_id = ' + parsedMessageData.user_id,
            'to chat_id = ' + responseData.chat_description.chat_id);
    },

    onDeviceChatJoin: function(cur_wsc, parsedMessageData) {
        cur_wsc.put_chat_id(parsedMessageData.chat_description.chat_id);
        cur_wsc.put_user_id(parsedMessageData.user_id);

        var responseData = {
            type: 'chat_joined',
            from_user_id: parsedMessageData.user_id,
            from_ws_device_id: cur_wsc.ws_device_id,
            wscs_device_ids: this.get_chat_wscs_device_ids(parsedMessageData.chat_description.chat_id),
            chat_description: parsedMessageData.chat_description,
            restore_chat_state: parsedMessageData.restore_chat_state
        };

        this.broadcast_chat_message(responseData);

        console.log('Join chat from',
            'ws_device_id = ' + cur_wsc.ws_device_id,
            'user_id = ' + responseData.user_id,
            'to chat_id = ' + responseData.chat_description.chat_id);
    },

    onDeviceChatOffer: function(cur_wsc, parsedMessageData) {
        cur_wsc.put_chat_id(parsedMessageData.chat_description.chat_id);
        cur_wsc.put_user_id(parsedMessageData.user_id);

        var target_wsc = this.wscc.get_wsc_by_ws_dev_id(parsedMessageData.to_ws_device_id);
        if (!target_wsc) {
            cur_wsc.send_error(new Error('Target connection is not found!'), parsedMessageData);
            return;
        }

        var responseData = {
            type: 'notifyChat',
            notify_data: 'handleDevicePassive',
            from_ws_device_id: cur_wsc.ws_device_id,
            from_user_id: parsedMessageData.user_id,
            offerDescription: parsedMessageData.offerDescription,
            to_ws_device_id: target_wsc.ws_device_id,
            chat_description: parsedMessageData.chat_description
        };

        target_wsc.send(JSON.stringify(responseData));

        console.log(
            'Offer from',
            'ws_device_id = ' + cur_wsc.ws_device_id,
            'to ws_device_id = ' + target_wsc.ws_device_id,
            'user_id = ' + responseData.user_id,
            'chat_id = ' + responseData.chat_description.chat_id);
    },

    onDeviceChatAnswer: function(cur_wsc, parsedMessageData) {
        cur_wsc.put_chat_id(parsedMessageData.chat_description.chat_id);
        cur_wsc.put_user_id(parsedMessageData.user_id);

        var target_wsc = this.wscc.get_ws_device_wsc(parsedMessageData.to_ws_device_id);
        if (!target_wsc) {
            cur_wsc.send_error(new Error('Target connection is not found!'), parsedMessageData);
            return;
        }

        var responseData = {
            type: 'notifyChat',
            notify_data: 'handleDeviceAnswer',
            from_ws_device_id: cur_wsc.ws_device_id,
            from_user_id: parsedMessageData.user_id,
            to_ws_device_id: target_wsc.ws_device_id,
            answerDescription: parsedMessageData.answerDescription,
            chat_description: parsedMessageData.chat_description
        };

        target_wsc.send(JSON.stringify(responseData));

        console.log(
            'Answer from',
            'ws_device_id = ' + cur_wsc.ws_device_id,
            'to ws_device_id = ' + target_wsc.ws_device_id,
            'user_id = ' + responseData.user_id,
            'chat_id = ' + responseData.chat_description.chat_id);
    },

    onDeviceChatAccept: function(cur_wsc, parsedMessageData) {
        cur_wsc.put_chat_id(parsedMessageData.chat_description.chat_id);
        cur_wsc.put_user_id(parsedMessageData.user_id);

        var target_wsc = this.wscc.get_wsc_by_ws_dev_id(parsedMessageData.to_ws_device_id);
        if (!target_wsc) {
            cur_wsc.send_error(new Error('Target connection is not found!'), parsedMessageData);
            return;
        }

        var responseData = {
            type: 'notifyChat',
            notify_data: 'serverStoredAccept',
            from_ws_device_id: parsedMessageData.ws_device_id,
            from_user_id: parsedMessageData.user_id,
            to_ws_device_id: target_wsc.ws_device_id,
            chat_description: parsedMessageData.chat_description
        };

        target_wsc.send(JSON.stringify(responseData));

        console.log(
            'Accept from',
            'ws_device_id = ' + responseData.ws_device_id,
            'to ws_device_id = ' + target_wsc.ws_device_id,
            'user_id = ' + responseData.user_id,
            'chat_id = ' + responseData.chat_description.chat_id);
    }
};

module.exports = Chats_message_router;