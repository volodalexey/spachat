var Server_chats_collection = require('./server_chats_collection');
var Server_users_collection = require('./server_users_collection');
var Server_message_router = function(options) {
    this.server_chats_collection = new Server_chats_collection();
    this.server_users_collection = new Server_users_collection();
    this.msgMap = {
        create_chat: this.server_chats_collection.onDeviceCreateChat,
        chat_join: this.server_chats_collection.onDeviceChatJoin,
        chat_offer: this.server_chats_collection.onDeviceChatOffer,
        chat_answer: this.server_chats_collection.onDeviceChatAnswer,
        chat_accept: this.server_chats_collection.onDeviceChatAccept,
        user_add: this.server_users_collection.onDeviceAddUser,
        user_toggle_ready: this.server_users_collection.onDeviceToggleReady
    };
    this.contextMap = {
        create_chat: this.server_chats_collection,
        chat_join: this.server_chats_collection,
        chat_offer: this.server_chats_collection,
        chat_answer: this.server_chats_collection,
        chat_accept: this.server_chats_collection,
        user_add: this.server_users_collection,
        user_toggle_ready: this.server_users_collection
    }
};

Server_message_router.prototype = {

    __class_name: "server_message_router",

    onMessage: function(webSocketConnection, messageData) {
        var _this = this;
        try {
            var parsedMessageData = JSON.parse(messageData);
        } catch (e) {
            console.log(e);
            return;
        }

        var handler = _this.msgMap[parsedMessageData.type];
        var context = _this.contextMap[parsedMessageData.type];
            console.log('Received message type => ', parsedMessageData.type);
        if (handler && context) {
            handler.call(context, webSocketConnection, parsedMessageData);
        }
    }
};

module.exports = Server_message_router;