var id_Generator = require('./id_generator');

var Web_socket_connection_model = function(wsConnection) {};

Web_socket_connection_model.prototype = {

    apply_new_wsc: function(wsc) {
        wsc.ws_device_id = id_Generator.generateId(); // temp device id until the device send offer
        wsc.chats_ids = [];
        wsc.users_ids = [];
        wsc.__proto__.put_user_id = Web_socket_connection_model.prototype.put_user_id;
        wsc.__proto__.put_chat_id = Web_socket_connection_model.prototype.put_chat_id;
        wsc.__proto__.sendError = Web_socket_connection_model.prototype.sendError;
        wsc.__proto__.has_user_id = Web_socket_connection_model.prototype.has_user_id;
        wsc.__proto__.has_chat_id = Web_socket_connection_model.prototype.has_chat_id;
        wsc.__proto__.get_ws_device_id = Web_socket_connection_model.prototype.get_ws_device_id;
    },

    clean_wsc: function(wsc) {
        wsc.ws_device_id = null;
        wsc.chats_ids = null;
        wsc.users_ids = null;
        wsc.__proto__.put_user_id = null;
        wsc.__proto__.put_chat_id = null;
        wsc.__proto__.sendError = null;
        wsc.__proto__.has_user_id = null;
        wsc.__proto__.has_chat_id = null;
        wsc.__proto__.get_ws_device_id = null;
    },

    has_user_id: function(userId) {
        var foundUserId = false;
        var wsc = this;
        wsc.users_ids.every(function(_userId) {
            if (_userId === userId) {
                foundUserId = _userId;
            }
            return !foundUserId;
        });
        return foundUserId;
    },

    has_chat_id: function(chat_id) {
        var foundChatId = false;
        var wsc = this;
        wsc.chats_ids.every(function(_chat_id) {
            if (_chat_id === chat_id) {
                foundChatId = _chat_id;
            }
            return !foundChatId;
        });
        return foundChatId;
    },

    put_user_id: function(userId) {
        var wsc = this;
        if (wsc.has_user_id(userId) === false) {
            wsc.users_ids.push(userId);
        }
    },

    put_chat_id: function(chat_id) {
        var wsc = this;
        if (wsc.has_chat_id(chat_id) === false) {
            wsc.chats_ids.push(chat_id);
        }
    },

    send_error: function(error, parsedMessageData) {
        var wsc = this;
        console.log(error);
        var strErr = JSON.stringify({
            message: error.toString(),
            type: "error",
            chat_description: parsedMessageData.chat_description
        });
        if (wsc.readyState !== wsc.CLOSED) {
            wsc.send(JSON.stringify(strErr));
        } // TODO remove from connections?
    },

    get_ws_device_id: function() {
        var wsc = this;
        return wsc.ws_device_id;
    }
};

module.exports = new Web_socket_connection_model();